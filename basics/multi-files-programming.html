<!DOCTYPE HTML>
<html lang="zh-Hans" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>C++ 多文件编程 - RM-CV Wiki</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../theme/css/custom-style.css">
        <link rel="stylesheet" href="../theme/css/custom-font.css">
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">前言</a></li><li class="chapter-item expanded "><a href="../basics/index.html"><strong aria-hidden="true">1.</strong> 基础知识</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../basics/projects-and-builds.html"><strong aria-hidden="true">1.1.</strong> 项目与构建</a></li><li class="chapter-item expanded "><a href="../basics/multi-files-programming.html" class="active"><strong aria-hidden="true">1.2.</strong> C++ 多文件编程</a></li><li class="chapter-item expanded "><a href="../basics/about-libraries.html"><strong aria-hidden="true">1.3.</strong> 代码库的概念</a></li><li class="chapter-item expanded "><a href="../basics/first-cmake.html"><strong aria-hidden="true">1.4.</strong> 初识 CMake</a></li></ol></li><li class="chapter-item expanded "><a href="../tools/index.html"><strong aria-hidden="true">2.</strong> 开发环境配置和使用</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../tools/vscode-cmake-extension.html"><strong aria-hidden="true">2.1.</strong> Visual Studio Code 中 CMake 插件的基本使用</a></li><li class="chapter-item expanded "><a href="../tools/dev-with-vcpkg-cmake-win.html"><strong aria-hidden="true">2.2.</strong> Windows 下使用 vcpkg + CMake 进行开发</a></li><li class="chapter-item expanded "><a href="../tools/connecting-to-github-with-ssh.html"><strong aria-hidden="true">2.3.</strong> 使用 SSH 连接到 GitHub</a></li></ol></li><li class="chapter-item expanded "><a href="../coding-tips/index.html"><strong aria-hidden="true">3.</strong> 编程技巧</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../coding-tips/float-to-string.html"><strong aria-hidden="true">3.1.</strong> C++ 浮点数转为字符串</a></li></ol></li><li class="chapter-item expanded "><a href="../TX2/index.html"><strong aria-hidden="true">4.</strong> TX2 使用笔记</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../TX2/new-to-tx2.html"><strong aria-hidden="true">4.1.</strong> 初识 TX2</a></li><li class="chapter-item expanded "><a href="../TX2/using-proxy.html"><strong aria-hidden="true">4.2.</strong> 在 TX2 上使用代理</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">RM-CV Wiki</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/MUC-RM-CV/wiki" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/MUC-RM-CV/wiki/edit/main/src/basics/multi-files-programming.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="c-多文件编程"><a class="header" href="#c-多文件编程">C++ 多文件编程</a></h1>
<p>在上一节 <a href="./projects-and-builds.html">&quot;项目与构建&quot;</a> 中说到, 现实中的项目通常较为复杂, 由若干模块组成. 本篇文章将简单介绍一下 C++ 中的多文件编程.</p>
<h2 id="多文件编程的好处"><a class="header" href="#多文件编程的好处">多文件编程的好处</a></h2>
<p>将代码分区放在不同的文件中，可以方便对于代码的查找、管理和协同工作.</p>
<p>此外，将代码分别放在不同的区块 (也叫做 &quot;翻译单元 (translation unit)&quot;) 中, 可以实现在修改一些文件时, 不至于重新编译整个工程.</p>
<h2 id="c-编译链接简介"><a class="header" href="#c-编译链接简介">C++ 编译链接简介</a></h2>
<p>先从最熟悉的单文件的情况说起. 下面是一个简单的 C++ 源文件，里面有一个 <code>foo</code> 函数和有一个 <code>main</code> 函数. </p>
<blockquote>
<p>一个 C++ 程序需要有 <code>main</code> 函数才能运行。</p>
</blockquote>
<pre><code class="language-cpp">// demo.cpp

int foo(int, int);  // foo 函数的声明

int main() {
    // main 函数是一个程序的起点
    int result = foo(3, 5);
    return 0;
}

int foo(int a, int b) {  // foo 函数的定义
    return 2 * a + b;
}
</code></pre>
<p>可以看到, 上述的代码中，<code>main</code> 函数调用了 <code>foo</code> 函数. 但这不是件理所当然的事.</p>
<p>事实上, 在 <strong>编译</strong> (compile) 过程中, 当编译器遇到 <code>foo(3, 5)</code> 这样的语句时, 会去查看是否存在这样的函数可供使用.</p>
<p>这个例子中, <code>foo</code> 函数的原型已在调用处之前声明, 因此编译器能够理解 <code>foo(3, 5)</code> 这样的语句.</p>
<pre><code class="language-cpp">int foo(int, int);  // foo 函数的声明
</code></pre>
<p>具体来说, 对于该语句, 编译器会去查找，是否有一个名为 <code>foo</code> 的函数 <strong>声明</strong> (declaration). 满足参数为两个 <code>int</code> 型整数的情况 (或者参数列表中参数类型支持从 <code>int</code> 类型转换而得); 如果没有, 编译器就会报错, 提示这个符号 &quot;还没有在作用中被声明 (was not declared in scope)&quot;, 或者说这是一个 &quot;未声明标识符 (undeclared identifier)&quot;.</p>
<p>但是现在还不能生成最终的可执行程序, 因为我们还不清楚 <code>foo</code> 函数的具体定义. 为此, 编译器会将这个符号加入到 <em>未解决符号表</em> 中。</p>
<p>在这个例子中, 编译器接着往下分析文件中的内容, 就会发现 <code>foo</code> 函数的定义, 并将其出现的位置记录下来, 供之后 <strong>链接</strong> (Linking) 阶段的使用.</p>
<p>如此, 编译器就从源代码文件生成了目标文件. 在链接过程中, 编译器根据未解决符号表, 在每个编译得到的目标文件中查找对应的符号, 查找到之后, 就记录下相应的位置, 也就是将不同位置的代码 &quot;链接&quot; 起来.</p>
<p>在上面的例子中, <code>foo(3, 5)</code> 这个语句将会找到在 <code>main</code> 函数之后定义的 <code>foo</code> 函数, 因此被解决. 否则, 将会出现 &quot;未解决的外部符号 (unresolved external symbol)&quot; 或者 &quot;未定义引用 (undefined reference)&quot; 的错误.</p>
<blockquote>
<p>也可以将函数和声明和函数定义写在一起, 比如下面这样:</p>
<pre><code class="language-cpp">// demo.cpp

int foo(int, int) { return 2 * a + b; }

int main() {
    int result = foo(3, 5);
    return 0;
}
</code></pre>
</blockquote>
<p>我们将每一个 C/C++ 源文件称作一个翻译单元 (translation unit)。那么在上述的例子中，我们的翻译单元会提供一个 <code>int foo(int, int)</code> 和一个 <code>int main()</code> 的符号，并且有一个 <code>int foo(int, int)</code> 的符号待解决。经过了链接过程，未解决符号得到了解决，于是就可以生成可执行程序了。</p>
<h2 id="将文件拆开"><a class="header" href="#将文件拆开">将文件拆开</a></h2>
<p>假如 <code>foo</code> 函数是一个经常会被用到的函数, 那么在单文件的情况时, 往往每编写一个新的程序, 都需要将其复制到新的源代码文件中.</p>
<p>这样做会产生很多重复的内容, 不利于对代码的维护, 并且有可能增加额外的编译时间.</p>
<p>通过之前的内容, 不难想到, 可以将 <code>foo</code> 函数单独存放在一个文件中. 如此, 只要提供声明, 其他的代码可以成功调用该函数, 只要确保 <code>foo</code> 函数编译后所在的目标文件也参与链接过程即可.</p>
<blockquote>
<p>接下来的例子中涉及到通过命令行操作编译器。读者只需要明白操作的目的即可，实际使用中不必要手动输入这些命令。</p>
</blockquote>
<p>下面的 <code>foo.cpp</code> 是一个包含 <code>foo</code> 函数的源代码文件:</p>
<pre><code class="language-cpp">// foo.cpp

int foo(int a, int b) {
    return 2 * a + b;
}
</code></pre>
<p>让编译器编译 <code>foo.cpp</code> 生成目标文件 <code>foo.o</code>:</p>
<pre><code class="language-console">$ c++ foo.cpp -c -o foo.o
</code></pre>
<p>不出意外的话, 当前目录下会多出一个名为 <code>foo.o</code> 的目标文件. 目标文件的内容一般不易为人类所阅读, 不过只要明白这个目标文件提供了 <code>int foo(int, int)</code> 这样一个符号即可.</p>
<p>而 <code>main.cpp</code> 将会写作下面的样子, 其中需要包含对 <code>foo</code> 函数的声明, 即可使用对应的函数, 并通过编译.</p>
<pre><code class="language-cpp">// main.cpp

int foo(int, int);  // 只需要 foo 函数的声明

int main() {
    int result = foo(3, 5);
    return 0;
}
</code></pre>
<p>同样, 将 <code>main.cpp</code> 编译为目标文件:</p>
<pre><code class="language-console">$ c++ main.cpp -c -o main.o
</code></pre>
<p>类似的, 这个目标文件提供了 <code>int main()</code> 这样一个符号，但有一个 <code>int foo(int, int)</code> 的符号待解决.</p>
<p>最后, 为了生成最后的可执行程序 <code>main</code>, 我们需要将这些目标文件链接起来:</p>
<pre><code class="language-console">$ c++ main.o foo.o -o main
</code></pre>
<p>如果一切顺利, 将不会出现未解决符号, 可执行文件生成成功.</p>
<h2 id="预处理指令"><a class="header" href="#预处理指令">预处理指令</a></h2>
<p>在编译之前, 编译器会先对代码文件进行预处理.</p>
<p>有很多预处理指令, 这些命令通常以 <code>#</code> 开始, 常见的有 <code>#define</code>、<code>#include</code> 等.</p>
<h3 id="条件编译"><a class="header" href="#条件编译">条件编译</a></h3>
<p>一般来说, <code>define</code> 可以声明一个宏, 或者可以将代码中的宏名替换为相应的内容. 除此之外, <code>define</code> 也可以和 <code>ifndef</code>, <code>ifndef</code> 命令配合起来实现 &quot;条件编译&quot;.</p>
<p>下面的代码中, 因为 <code>define</code> 过名为 <code>FLAG</code> 的宏 (macro), 因此 <code>ifdef</code> 命令条件为真, 故 <code>#ifdef FLAG</code> 和 <code>#endif</code> 之间的代码将会出现在预处理过的代码中; 反之, 如果没有定义过 <code>FLAG</code>, 其间的代码将不会出现在预处理之后的结果中.</p>
<pre><code class="language-cpp">#define FLAG

int foo(int, int);

int main() {
#ifdef FLAG
    foo(3, 4);
#endif
    return 0;
}
</code></pre>
<p><code>ifndef</code> 的作用和 <code>ifdef</code> 相反. 即, 没有定义过相应的宏名, 才会满足条件. 下面的代码中, <code>#ifndef FLAG</code> 和 <code>#endif</code> 之间的代码不会出现在预处理的结果中.</p>
<pre><code class="language-cpp">#define FLAG

int foo(int, int);

int main() {
#ifndef FLAG
    foo(3, 4);
#endif
    return 0;
}
</code></pre>
<h3 id="include-包含命令"><a class="header" href="#include-包含命令"><code>include</code> 包含命令</a></h3>
<p><code>include</code> 命令则会将被包含文件的内容原样复制到文件的对应位置里. 这里不再举例.</p>
<h2 id="使用头文件"><a class="header" href="#使用头文件">使用头文件</a></h2>
<p>在前面的例子中, 我们在 <code>main.cpp</code> 中手动写入了 <code>int foo(int, int);</code> 的声明. 但当声明较多时，手动编写或复制仍是比较麻烦的.</p>
<p><code>include</code> 命令可以轻松实现代码的包含引入.</p>
<p>为 <code>foo.cpp</code> 编写相应的头文件 (header) <code>foo.h</code> 之后, 便只需在调用处 --- 比如 <code>main.cpp</code> 中 --- 包含 (include) 对应的头文件即可。</p>
<p>还是使用前文用到的例子, 接下来将其拆分成以下三个文件, 并添加一些其他的内容:</p>
<ul>
<li><a href="./assets/1/foo.h">foo.h</a></li>
<li><a href="./assets/1/foo.cpp">foo.cpp</a></li>
<li><a href="./assets/1/main.cpp">main.cpp</a></li>
</ul>
<pre><code class="language-cpp">// foo.h

#ifndef FOO_H
#define FOO_H

int foo(int, int);

inline void func() { return; }  // 内联函数

class A {  // A 类型的声明
    int num;
public:
    A() = default;
    int get_num() {  // 直接写在类中的函数也是内联的
        return this-&gt;num;
    }
    void set_num(int num_) {
        this-&gt;num = num_;
    }
    void add(int m);  // 成员函数的实现也可以放在 cpp 中（类外实现）
};

#endif  // FOO_H
</code></pre>
<p>注意，<a href="./assets/1/foo.h">foo.h</a> 中使用 <code>ifndef</code> 等命令实现了该文件在每个翻译单元中仅会被包含一次。这叫做头文件保护 (header guards)。如果用户在一个源文件中不小心引用了两次头文件，或是包含的若干个头文件中都包含了某个头文件，那么将会出现同一个头文件在一个源文件中被引用多次的情况，即造成了重复声明。</p>
<p>此外，头文件中一般不能包含函数定义。试想，如果包含了函数定义的头文件被多个源代码文件包含，则这些源代码文件编译生成的目标文件中都会出现相同的符号。这会导致链接过程中链接器无法决定该使用哪一个符号。同理，也不应该使用 <code>include</code> 将函数定义的代码直接包含进源代码文件。</p>
<blockquote>
<p>不过, 实际使用中也会出现需要将一些常用的函数放在头文件中的情况, 也就是说, 这一函数会在很多源文件中用到. 在经过编译后, 各个目标文件中均会出现这些相同的符号, 而我们不希望它们链接时发生冲突, 因此需要使用 <code>inline</code> 关键字修饰它们.</p>
<p>另一种情况是, 我们希望一个函数仅在当前翻译单元可用, 而在不同的翻译单元中可能存在同名但定义不同的函数. 这时应用 <code>static</code> 关键字修饰它们. </p>
<p>需要注意, 类的声明中直接写出的函数都会被视作 <code>inline</code> 的来处理.</p>
</blockquote>
<pre><code class="language-cpp">// foo.cpp

#include &quot;foo.h&quot;

static int f(int a, int b) { return a - b; }

int foo(int a, int b) {
    
    a = f(a, b);

    A inst_1;  // 使用了 foo.h 中的 A 类型，因此需要引用 foo.h
    inst_1.set_num(2 * a);
    inst_1.add(b);

    return inst_1.get_num();
}

void A::add(int n) {
    this-&gt;num += n;
}
</code></pre>
<p>在 <a href="./assets/1/foo.cpp">foo.cpp</a> 中，同样引用了相对应的头文件，这是由于，头文件中可能包含了一些结构或类型的声明，或者包含其他的一些头文件。这时候，需要引用该头文件，否则编译时将会出现未声明符号的问题。</p>
<pre><code class="language-cpp">// main.cpp

#include &quot;foo.h&quot;

static int f(int a, int b) { return a + b; }

int main() {
    int result = foo(2, 3);
    int t = f(4, 5);
}
</code></pre>
<p>最后，<a href="./assets/1/main.cpp">main.cpp</a> 中只需要调用 <a href="./assets/1/foo.h">foo.h</a> 中提供的符号即可。</p>
<p>在编译的时候，分别生成目标文件：</p>
<pre><code class="language-console">$ c++ foo.cpp -c -o foo.o
$ c++ main.cpp -c -o main.o
</code></pre>
<p>再执行链接操作：</p>
<pre><code class="language-console">$ c++ main.o foo.o -o main
</code></pre>
<p>参考资料：</p>
<ul>
<li><a href="https://en.cppreference.com/w/c/language/storage_duration">https://en.cppreference.com/w/c/language/storage_duration</a></li>
<li><a href="https://en.cppreference.com/w/cpp/language/storage_duration">https://en.cppreference.com/w/cpp/language/storage_duration</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../basics/projects-and-builds.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../basics/about-libraries.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../basics/projects-and-builds.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../basics/about-libraries.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
